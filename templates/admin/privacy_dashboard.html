{% extends 'base.html' %}

{% block title %}Privacy Settings Dashboard{% endblock %}

{% block content %}
<div class="container py-5">
    <h1 class="mb-4">Privacy Settings Dashboard</h1>
    
    <div class="row">
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Differential Privacy Settings</h5>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <h6>Current Status</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><strong>Status:</strong></label>
                                    <div>
                                        <span class="badge {% if privacy_status.enabled %}bg-success{% else %}bg-danger{% endif %} p-2">
                                            {{ 'Enabled' if privacy_status.enabled else 'Disabled' }}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><strong>Epsilon Value:</strong></label>
                                    <div>{{ privacy_status.epsilon }}</div>
                                    <small class="text-muted">Lower = More Privacy</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label"><strong>Mechanism:</strong></label>
                                    <div>{{ privacy_status.mechanism }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Toggle Privacy</h6>
                        <button id="togglePrivacy" class="btn {% if privacy_status.enabled %}btn-danger{% else %}btn-success{% endif %}">
                            {{ 'Disable Privacy' if privacy_status.enabled else 'Enable Privacy' }}
                        </button>
                    </div>
                    
                    <div class="mb-4">
                        <h6>Update Privacy Settings</h6>
                        <form id="updatePrivacyForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="epsilonInput" class="form-label">Epsilon Value</label>
                                        <input type="number" class="form-control" id="epsilonInput" value="{{ privacy_status.epsilon }}" 
                                               min="0.1" max="10" step="0.1" required>
                                        <div class="form-text">
                                            Privacy-utility trade-off parameter:
                                            <ul class="mt-1">
                                                <li>0.1 - 0.5: High privacy, lower accuracy</li>
                                                <li>0.5 - 2.0: Balanced privacy and accuracy</li>
                                                <li>2.0 - 10.0: Higher accuracy, less privacy</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="mechanismSelect" class="form-label">Privacy Mechanism</label>
                                        <select class="form-select" id="mechanismSelect" required>
                                            <option value="laplace" {% if privacy_status.mechanism == 'laplace' %}selected{% endif %}>
                                                Laplace (General purpose)
                                            </option>
                                            <option value="gaussian" {% if privacy_status.mechanism == 'gaussian' %}selected{% endif %}>
                                                Gaussian (Better for large datasets)
                                            </option>
                                            <option value="randomized_response" {% if privacy_status.mechanism == 'randomized_response' %}selected{% endif %}>
                                                Randomized Response (For categorical data)
                                            </option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Settings</button>
                        </form>
                    </div>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Differential privacy adds controlled noise to protect user privacy while maintaining utility.
                    </small>
                </div>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">Recommendation System Status</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label"><strong>Training Status:</strong></label>
                                <div>
                                    <span class="badge {% if training_status.is_trained %}bg-success{% else %}bg-warning{% endif %} p-2">
                                        {{ 'Trained' if training_status.is_trained else 'Not Trained' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label"><strong>Users:</strong></label>
                                <div>{{ training_status.user_count }}</div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label"><strong>Items:</strong></label>
                                <div>{{ training_status.item_count }}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <a href="/admin/train-models" class="btn btn-warning">
                            <i class="fas fa-cogs me-1"></i> Retrain Models
                        </a>
                        <small class="text-muted ms-2">
                            Retraining applies current privacy settings to all models
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header bg-secondary text-white">
                    <h5 class="mb-0">Privacy Impact</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <h6>Current Privacy-Utility Trade-off</h6>
                        <div class="progress mb-2" style="height: 25px;" id="privacyBar"
                             data-enabled="{{ privacy_status.enabled }}" 
                             data-epsilon="{{ privacy_status.epsilon }}">
                            <div class="progress-bar bg-success" role="progressbar" 
                                 style="width: 0%;" id="privacyLevel">
                                Privacy: 0%
                            </div>
                        </div>
                        
                        <div class="progress" style="height: 25px;" id="utilityBar">
                            <div class="progress-bar bg-primary" role="progressbar" 
                                 style="width: 0%;" id="utilityLevel">
                                Utility: 0%
                            </div>
                        </div>
                    </div>
                    
                    <h6 class="mt-4">Expected Effects</h6>
                    <ul class="list-group">
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            User Privacy Protection
                            <span class="badge bg-primary rounded-pill">
                                {{ "High" if privacy_status.epsilon < 1 else "Medium" if privacy_status.epsilon < 3 else "Low" }}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Recommendation Accuracy
                            <span class="badge bg-primary rounded-pill">
                                {{ "Low" if privacy_status.epsilon < 1 else "Medium" if privacy_status.epsilon < 3 else "High" }}
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            Data Leakage Risk
                            <span class="badge bg-primary rounded-pill">
                                {{ "Low" if privacy_status.epsilon < 1 else "Medium" if privacy_status.epsilon < 3 else "High" }}
                            </span>
                        </li>
                    </ul>
                </div>
                <div class="card-footer">
                    <small class="text-muted">
                        Adjust epsilon to find the right balance between privacy and recommendation quality
                    </small>
                </div>
            </div>
            
            <div class="card">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Privacy Resources</h5>
                </div>
                <div class="card-body">
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <a href="https://arxiv.org/abs/1907.09025" target="_blank">
                                <i class="fas fa-external-link-alt me-1"></i>
                                Differentially Private Recommendation Systems
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://arxiv.org/abs/1607.00133" target="_blank">
                                <i class="fas fa-external-link-alt me-1"></i>
                                Deep Learning with Differential Privacy
                            </a>
                        </li>
                        <li class="list-group-item">
                            <a href="https://opendp.org/" target="_blank">
                                <i class="fas fa-external-link-alt me-1"></i>
                                OpenDP - Differential Privacy Tools
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Calculate privacy and utility levels
        const privacyBar = document.getElementById('privacyBar');
        const privacyLevel = document.getElementById('privacyLevel');
        const utilityLevel = document.getElementById('utilityLevel');
        
        if (privacyBar && privacyLevel && utilityLevel) {
            const isEnabled = privacyBar.dataset.enabled === 'True';
            const epsilon = parseFloat(privacyBar.dataset.epsilon);
            
            let privacyValue = 0;
            if (isEnabled && !isNaN(epsilon) && epsilon > 0) {
                privacyValue = (1 / epsilon) * 100;
                if (privacyValue > 100) privacyValue = 100;
            }
            
            const utilityValue = 100 - privacyValue;
            
            // Set the progress bar widths
            privacyLevel.style.width = privacyValue + '%';
            privacyLevel.textContent = 'Privacy: ' + privacyValue.toFixed(1) + '%';
            
            utilityLevel.style.width = utilityValue + '%';
            utilityLevel.textContent = 'Utility: ' + utilityValue.toFixed(1) + '%';
        }
        
        // Toggle privacy
        const toggleBtn = document.getElementById('togglePrivacy');
        if (toggleBtn) {
            toggleBtn.addEventListener('click', function() {
                fetch('/admin/toggle-privacy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while toggling privacy settings');
                });
            });
        }
        
        // Update privacy settings
        const updateForm = document.getElementById('updatePrivacyForm');
        if (updateForm) {
            updateForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const epsilon = document.getElementById('epsilonInput').value;
                const mechanism = document.getElementById('mechanismSelect').value;
                
                fetch('/admin/update-privacy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        epsilon: epsilon,
                        mechanism: mechanism
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while updating privacy settings');
                });
            });
        }
    });
</script>
{% endblock %}